<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>月订单对比工具</title>
  <style>
    :root {
      color-scheme: light;
      --blue: #2563eb;
      --blue-dark: #1d4ed8;
      --border: #e5e7eb;
      --text: #1f2937;
      --muted: #6b7280;
      --bg: #f8fafc;
    }
    body {
      font-family: "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px 32px;
      color: var(--text);
      background: var(--bg);
    }
    h1 { margin: 0 0 8px; }
    .desc { color: var(--muted); margin-bottom: 14px; }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.04);
    }
    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
      color: #374151;
      font-weight: 600;
    }
    .help { color: var(--muted); font-size: 13px; margin-top: 6px; }
    input[type="file"], select {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 8px;
      box-sizing: border-box;
      background: #fff;
    }
    button {
      margin-top: 10px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: #fff;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
    }
    button:hover { background: var(--blue-dark); }
    .stats {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      margin-top: 6px;
    }
    .stat {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      background: #fff;
    }
    .stat .num { font-size: 24px; font-weight: 700; color: #111827; }
    .status { margin-top: 8px; font-size: 14px; }
    .status.error { color: #b91c1c; }
    .status.ok { color: #047857; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
      font-size: 14px;
      vertical-align: top;
    }
    th { background: #f3f4f6; }
    .table-wrap { overflow-x: auto; }
  </style>
</head>
<body>
  <h1>月订单对比工具（WPS 导出文件可用）</h1>
  <p class="desc">上传官方月订单表和客户手工月订单表，自动比对重复订单号、官方漏单、客户多报，并可导出结果。</p>

  <div class="card">
    <div class="grid">
      <div>
        <label for="officialFile">官方导出月订单表（xlsx/xls/csv）</label>
        <input id="officialFile" type="file" accept=".xlsx,.xls,.csv" />
        <div class="help" id="officialInfo"></div>
      </div>
      <div>
        <label for="clientFile">客户手工月订单表（xlsx/xls/csv）</label>
        <input id="clientFile" type="file" accept=".xlsx,.xls,.csv" />
        <div class="help" id="clientInfo"></div>
      </div>
    </div>

    <div class="grid" style="margin-top: 12px;">
      <div>
        <label for="officialColumn">官方表订单号字段</label>
        <select id="officialColumn"></select>
      </div>
      <div>
        <label for="clientColumn">客户表订单号字段</label>
        <select id="clientColumn"></select>
      </div>
    </div>

    <button id="compareBtn">开始对比</button>
    <button id="exportBtn" disabled>导出结果 CSV</button>
    <div id="status" class="status"></div>
  </div>

  <div class="card">
    <h3>对比汇总</h3>
    <div class="stats">
      <div class="stat"><div class="num" id="officialCount">0</div><div>官方订单号总数</div></div>
      <div class="stat"><div class="num" id="clientCount">0</div><div>客户订单号总数</div></div>
      <div class="stat"><div class="num" id="dupCount">0</div><div>两边重复订单号</div></div>
      <div class="stat"><div class="num" id="missingInClient">0</div><div>官方有/客户漏掉</div></div>
      <div class="stat"><div class="num" id="extraInClient">0</div><div>客户有/官方没有</div></div>
    </div>
  </div>

  <div class="card table-wrap">
    <h3>明细表</h3>
    <table>
      <thead>
        <tr>
          <th>类型</th>
          <th>订单号</th>
        </tr>
      </thead>
      <tbody id="resultBody">
        <tr><td colspan="2">暂无结果</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const state = {
      officialRows: [],
      clientRows: [],
      resultRows: []
    };

    const orderFieldHints = ["订单号", "订单编号", "order_no", "order id", "orderid", "单号"];

    const $ = (id) => document.getElementById(id);
    const setStatus = (msg, isError = false) => {
      const node = $("status");
      node.textContent = msg;
      node.className = "status " + (isError ? "error" : "ok");
    };

    const parseFile = async (file) => {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: "array" });
      const firstSheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[firstSheetName];
      return XLSX.utils.sheet_to_json(sheet, { defval: "" });
    };

    const normalize = (value) => String(value || "").trim();

    const bestOrderField = (headers) => {
      const lowerHeaders = headers.map((h) => h.toLowerCase());
      for (const hint of orderFieldHints) {
        const idx = lowerHeaders.findIndex((h) => h.includes(hint.toLowerCase()));
        if (idx >= 0) return headers[idx];
      }
      return headers[0] || "";
    };

    const fillSelect = (selectId, rows) => {
      const select = $(selectId);
      select.innerHTML = "";
      const headers = rows.length ? Object.keys(rows[0]) : [];
      headers.forEach((h) => {
        const option = document.createElement("option");
        option.value = h;
        option.textContent = h;
        select.appendChild(option);
      });
      const guess = bestOrderField(headers);
      if (guess) select.value = guess;
    };

    const handleFileChange = async (inputId, infoId, key, selectId) => {
      const file = $(inputId).files[0];
      if (!file) return;
      try {
        const rows = await parseFile(file);
        state[key] = rows;
        $(infoId).textContent = `已读取 ${rows.length} 行，文件：${file.name}`;
        fillSelect(selectId, rows);
        setStatus("文件读取成功，可开始对比。", false);
      } catch (err) {
        console.error(err);
        setStatus(`读取失败：${file.name}，请确认是 WPS 导出的 xlsx/xls/csv。`, true);
      }
    };

    const extractSet = (rows, column) => {
      const values = rows.map((r) => normalize(r[column])).filter(Boolean);
      return new Set(values);
    };

    const compare = () => {
      if (!state.officialRows.length || !state.clientRows.length) {
        setStatus("请先上传两份月订单表。", true);
        return;
      }
      const officialColumn = $("officialColumn").value;
      const clientColumn = $("clientColumn").value;
      if (!officialColumn || !clientColumn) {
        setStatus("请先选择订单号字段。", true);
        return;
      }

      const officialSet = extractSet(state.officialRows, officialColumn);
      const clientSet = extractSet(state.clientRows, clientColumn);

      const duplicates = [...officialSet].filter((id) => clientSet.has(id)).sort();
      const missing = [...officialSet].filter((id) => !clientSet.has(id)).sort();
      const extras = [...clientSet].filter((id) => !officialSet.has(id)).sort();

      state.resultRows = [
        ...duplicates.map((v) => ({ type: "两边重复", orderNo: v })),
        ...missing.map((v) => ({ type: "官方有/客户漏掉", orderNo: v })),
        ...extras.map((v) => ({ type: "客户有/官方没有", orderNo: v }))
      ];

      $("officialCount").textContent = officialSet.size;
      $("clientCount").textContent = clientSet.size;
      $("dupCount").textContent = duplicates.length;
      $("missingInClient").textContent = missing.length;
      $("extraInClient").textContent = extras.length;

      renderRows(state.resultRows);
      $("exportBtn").disabled = state.resultRows.length === 0;
      setStatus("对比完成。", false);
    };

    const renderRows = (rows) => {
      const tbody = $("resultBody");
      tbody.innerHTML = "";
      if (!rows.length) {
        tbody.innerHTML = "<tr><td colspan='2'>没有差异</td></tr>";
        return;
      }
      for (const row of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.type}</td><td>${row.orderNo}</td>`;
        tbody.appendChild(tr);
      }
    };

    const exportCsv = () => {
      const header = ["类型", "订单号"];
      const lines = [header.join(","), ...state.resultRows.map((r) => `${r.type},${r.orderNo}`)];
      const blob = new Blob(["\uFEFF" + lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `订单对比结果_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    $("officialFile").addEventListener("change", () =>
      handleFileChange("officialFile", "officialInfo", "officialRows", "officialColumn")
    );
    $("clientFile").addEventListener("change", () =>
      handleFileChange("clientFile", "clientInfo", "clientRows", "clientColumn")
    );
    $("compareBtn").addEventListener("click", compare);
    $("exportBtn").addEventListener("click", exportCsv);
  </script>
</body>
</html>
