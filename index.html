<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arbitrum Sepolia Counter DApp</title>
</head>
<body>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 560px;
      margin: 40px auto;
      padding: 0 16px;
      line-height: 1.6;
      color: #1f2933;
    }
    h1 { margin-bottom: 8px; }
    .card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 16px;
      margin-top: 12px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
    }
    button {
      padding: 10px 16px;
      margin-right: 8px;
      margin-bottom: 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) { background: #1d4ed8; }
    .status { font-size: 14px; color: #4b5563; }
    .error { color: #b91c1c; font-size: 14px; }
    .success { color: #047857; font-size: 14px; }
    .row { margin: 6px 0; }
  </style>

  <h1>Arbitrum Sepolia Counter DApp</h1>
  <div class="status">状态：<span id="status">未连接</span></div>
  <div class="status">账号：<span id="account">-</span></div>
  <div class="status">网络：<span id="network">-</span></div>

  <div class="card">
    <div class="row">
      <button id="connect">连接 OKX 钱包</button>
      <button id="inc" disabled>增加 count</button>
      <button id="set" disabled>设置 count = 10</button>
    </div>
    <div class="row">当前 count: <span id="value">-</span></div>
    <div class="row success" id="msg"></div>
    <div class="row error" id="error"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.min.js"></script>
  <script>
    const contractAddress = "0xb25EA940aCf9fe9d5097Aef885229944F8A06eA7";
    const abi = [
      "function count() view returns (uint256)",
      "function increment()",
      "function set(uint256 _v)"
    ];

    const targetChainIdHex = "0x66eed"; // Arbitrum Sepolia 421614
    let provider, signer, contract, pollTimer;

    const $ = (id) => document.getElementById(id);
    const setMsg = (text) => { $("msg").innerText = text || ""; };
    const setError = (text) => { $("error").innerText = text || ""; };
    const setStatus = (text) => { $("status").innerText = text; };

    const getInjectedProvider = () =>
      window.okxwallet?.ethereum || window.ethereum;

    const ensureProvider = () => {
      const injected = getInjectedProvider();
      if (!injected) {
        setError("未检测到 OKX/以太坊钱包，请先安装插件。");
        return null;
      }
      return injected;
    };

    const ensureNetwork = async (eth) => {
      const current = await eth.request({ method: "eth_chainId" });
      if (current === targetChainIdHex) return true;
      try {
        await eth.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: targetChainIdHex }]
        });
        return true;
      } catch (err) {
        setError("请切换到 Arbitrum Sepolia 网络后再试。");
        return false;
      }
    };

    const setupContract = async () => {
      const eth = ensureProvider();
      if (!eth) return;
      if (!(await ensureNetwork(eth))) return;

      provider = new ethers.BrowserProvider(eth);
      signer = await provider.getSigner();
      contract = new ethers.Contract(contractAddress, abi, signer);

      const addr = await signer.getAddress();
      const net = await provider.getNetwork();
      $("account").innerText = addr;
      $("network").innerText = net.name || net.chainId;
      setStatus("已连接");
      setMsg("钱包已连接，可进行操作。");
      setError("");

      $("inc").disabled = false;
      $("set").disabled = false;

      startPolling();
    };

    const startPolling = () => {
      clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        if (!contract) return;
        try {
          $("value").innerText = (await contract.count()).toString();
        } catch (err) {
          setError("读取合约失败，请检查网络/权限。");
        }
      }, 2000);
    };

    $("connect").onclick = async () => {
      try {
        const eth = ensureProvider();
        if (!eth) return;
        await eth.request({ method: "eth_requestAccounts" });
        await setupContract();
      } catch (err) {
        console.error(err);
        setError("连接失败：" + (err?.message || "未知错误"));
      }
    };

    $("inc").onclick = async () => {
      if (!contract) return setError("请先连接钱包");
      try {
        setMsg("发送交易中...");
        const tx = await contract.increment();
        await tx.wait();
        setMsg("交易完成，计数已更新");
      } catch (err) {
        console.error(err);
        setError("交易失败：" + (err?.message || "未知错误"));
      }
    };

    $("set").onclick = async () => {
      if (!contract) return setError("请先连接钱包");
      try {
        setMsg("发送交易中...");
        const tx = await contract.set(10);
        await tx.wait();
        setMsg("交易完成，已设置为 10");
      } catch (err) {
        console.error(err);
        setError("交易失败：" + (err?.message || "未知错误"));
      }
    };

    // 账户或网络切换时同步 UI
    const eth = getInjectedProvider();
    if (eth) {
      eth.on?.("accountsChanged", () => {
        setStatus("账号变更，需重新连接");
        $("inc").disabled = true;
        $("set").disabled = true;
        contract = null;
        clearInterval(pollTimer);
      });
      eth.on?.("chainChanged", () => {
        setStatus("网络变更，需重新连接");
        $("inc").disabled = true;
        $("set").disabled = true;
        contract = null;
        clearInterval(pollTimer);
      });
    }
  </script>
</body>
</html>
